name: CI ‚Äî build & push

on:
  push:
    branches: [ master ]           # –ø—É—à–∏ –≤ master –≤—ã–∑—ã–≤–∞—é—Ç CI
    tags:     [ 'v*' ]             # –∞ –µ—â—ë –º–æ–∂–Ω–æ –ø—É—à–∏—Ç—å —Ç–µ–≥–∏ v1.2.3

env:
  REGISTRY: docker.io              # üëà —É–¥–æ–±–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ —Å—é–¥–∞
  IMAGE_NAME: cybersec7007/django-demo

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # –≤—ã—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–≥:
      - name: Decide image tag
        id: vars
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}"   >>"$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_SHA::8}"           >>"$GITHUB_OUTPUT"
          fi

      # –ª–æ–≥–∏–Ω–∏–º—Å—è –≤ Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      # –±–∏–ª–¥–∏–º –∏ –ø—É—à–∏–º
      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag }}
